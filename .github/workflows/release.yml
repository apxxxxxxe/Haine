name: release-with-tag

on:
  push:
    tags:
      - 'v*'

env:
  NAR_NAME: Haine
  FETCH_DEPTH: 30
  MAIN_BRANCH: main

jobs:
  release-with-tag:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ env.MAIN_BRANCH }}
        fetch-depth: ${{ env.FETCH_DEPTH }}
        submodules: 'recursive'

    - name: tag name
      run: |
        git pull --tags
        # ã‹ã‚‰æœ€æ–°ã‚¿ã‚°ã¾ã§ã®ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ã—ã¦env.BODYã«æ ¼ç´
        LATEST_TAG=$(git tag --sort=-creatordate | head -n1 || echo "")
        SEMI_LATEST_TAG=$(git tag --sort=-creatordate | head -n2 | tail -n1 || echo "")
        echo "LATEST_TAG: $LATEST_TAG"
        echo "SEMI_LATEST_TAG: $SEMI_LATEST_TAG"
        if [ -n "$LATEST_TAG" ]; then
          git log "${SEMI_LATEST_TAG}..${LATEST_TAG}" --pretty=format:"%s" \
            | grep -v "update md5" \
            | grep -v "Merge pull request" \
            | grep -v "Merge branch" \
            | grep -v "Merge remote-tracking" \
            | grep -v â™»ï¸" \
            | grep -v ğŸ”–" \
            | grep -v ğŸ”§" \
            | grep -v ğŸ”¨" \
            | grep -v âœ…" \
            | grep -v ğŸ’š" \
            | sed -e 's/^/- /'
        else
          git log --pretty=format:"%s" \
            | grep -v "update md5" \
            | grep -v "Merge pull request" \
            | grep -v "Merge branch" \
            | grep -v "Merge remote-tracking" \
            | grep -v â™»ï¸" \
            | grep -v ğŸ”–" \
            | grep -v ğŸ”§" \
            | grep -v ğŸ”¨" \
            | grep -v âœ…" \
            | grep -v ğŸ’š" \
            | sed -e 's/^/- /' \
            | head -n ${{ env.FETCH_DEPTH }}
        fi
        {
          echo "BODY<<EOF"
          if [ -n "$LATEST_TAG" ]; then
            git log "${SEMI_LATEST_TAG}..${LATEST_TAG}" --pretty=format:"%s" \
              | grep -v "update md5" \
              | grep -v "Merge pull request" \
              | grep -v "Merge branch" \
              | grep -v "Merge remote-tracking" \
              | grep -v â™»ï¸" \
              | grep -v ğŸ”–" \
              | grep -v ğŸ”§" \
              | grep -v ğŸ”¨" \
              | grep -v âœ…" \
              | grep -v ğŸ’š" \
              | sed -e 's/^/- /'
            echo "EOF"
          else
            git log --pretty=format:"%s" \
              | grep -v "update md5" \
              | grep -v "Merge pull request" \
              | grep -v "Merge branch" \
              | grep -v "Merge remote-tracking" \
              | grep -v â™»ï¸" \
              | grep -v ğŸ”–" \
              | grep -v ğŸ”§" \
              | grep -v ğŸ”¨" \
              | grep -v âœ…" \
              | grep -v ğŸ’š" \
              | sed -e 's/^/- /' \
              | head -n 5
            echo "EOF"
          fi
        } >> $GITHUB_ENV

    - name: Zip output
      run: |
        mkdir -p /tmp/nar_temp
        rsync -av --filter=':- md5buildignore.txt' . /tmp/nar_temp/
        echo "=== Files to be included in NAR ==="
        find /tmp/nar_temp -type f | sort
        echo "==================================="
        cd /tmp/nar_temp
        zip -r $GITHUB_WORKSPACE/${{ env.NAR_NAME }}.nar *

    - name: Upload Release Asset(with tag)
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ${{ env.NAR_NAME }}.nar
        body: |
          ${{ env.BODY }}
