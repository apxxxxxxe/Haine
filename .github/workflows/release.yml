name: release-with-tag

on:
  push:
    tags:
      - 'v*'
  workflow_call:

env:
  NAR_NAME: Haine

jobs:
  release-with-tag:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: tag name
      if: github.event_name == 'workflow_run'
      run: echo "TAG_NAME=開発版-$(date +'%Y%m%d%H%M%S')" >> $GITHUB_ENV

    - name: tag push
      if: github.event_name == 'workflow_run'
      run: |
        git tag | grep 開発版 \
        | xargs -I{} sh -c "git tag -d {}; git push --delete origin tag {}"
        git pull
        git tag "${{ env.TAG_NAME }}"
        git push --tags

    - name: Zip output
      run: |
        zip -r ${{ env.NAR_NAME }}.nar * -x readme.md -x .git/\* -x .github/\* -x .git* -x ${{ env.NAR_NAME }}.nar -x ghost/master/rustfmt.toml -x ghost/master/.cargo\* -x ghost/master/Cargo\* -x ghost/master/src/\* -x ghost/master/ipadic\* -x md5buildignore.txt -x build\*

    - name: Check event name
      run: echo "event name is ${{ github.event_name }}"

    - name: Upload Release Asset(with tag)
      uses: softprops/action-gh-release@v2
      if: github.event_name == 'push'
      with:
        files: |
          ${{ env.NAR_NAME }}.nar

    - name: Upload Release Asset(pre-release per push)
      uses: softprops/action-gh-release@v2
      if: github.event_name == 'workflow_run'
      with:
        tag_name: ${{ env.TAG_NAME }}
        body: |
          **注意**
          このリリースは開発版です。  
          現時点での設定や機能は今後変更・削除される可能性があります。
        files: |
          ${{ env.NAR_NAME }}.nar
        prerelease: true
