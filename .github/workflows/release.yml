name: release-with-tag

on:
  push:
    tags:
      - 'v*'
  workflow_call:

env:
  NAR_NAME: Haine

jobs:
  release-with-tag:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: tag name
      if: github.event_name == 'workflow_run'
      run: |
        # 現在の日付を取得
        CURRENT_DATE=$(TZ="Asia/Tokyo" date +"%Y-%m-%d")

        # その日付に該当するタグを取得
        TAG_PREFIX="開発版-${CURRENT_DATE}-"
        EXISTING_TAGS=$(git tag | grep "^${TAG_PREFIX}" || true)

        if [ -z "$EXISTING_TAGS" ]; then
          # その日の日付で該当タグがない場合、part1を作成
          NEW_TAG="${TAG_PREFIX}1"
        else
          # すでにタグがある場合、最大のpartXを探してインクリメント
          MAX_PART=0
          for TAG in $EXISTING_TAGS; do
            PART_NUM=$(echo "$TAG" | sed -E "s/^${TAG_PREFIX}([0-9]+)$/\1/")
            if [ "$PART_NUM" -gt "$MAX_PART" ]; then
              MAX_PART=$PART_NUM
            fi
          done

          # インクリメント
          NEXT_PART=$((MAX_PART + 1))
          NEW_TAG="${TAG_PREFIX}${NEXT_PART}"
        fi

        echo "新しいタグを作成: $NEW_TAG"
        echo "TAG_NAME=$NEW_TAG" >> $GITHUB_ENV

    - name: tag push
      if: github.event_name == 'workflow_run'
      run: |
        while read tag; do
          git tag -d $tag
          git push --delete origin tag $tag
        done < <(git tag | grep 開発版)
        git pull
        git tag "${{ env.TAG_NAME }}"
        git push --tags

    - name: Zip output
      run: |
        zip -r ${{ env.NAR_NAME }}.nar * -x readme.md -x .git/\* -x .github/\* -x .git* -x ${{ env.NAR_NAME }}.nar -x ghost/master/rustfmt.toml -x ghost/master/.cargo\* -x ghost/master/Cargo\* -x ghost/master/src/\* -x ghost/master/ipadic\* -x md5buildignore.txt -x build\*

    - name: Check event name
      run: echo "event name is ${{ github.event_name }}"

    - name: Upload Release Asset(with tag)
      uses: softprops/action-gh-release@v2
      if: github.event_name == 'push'
      with:
        files: |
          ${{ env.NAR_NAME }}.nar

    - name: Upload Release Asset(pre-release per push)
      uses: softprops/action-gh-release@v2
      if: github.event_name == 'workflow_run'
      with:
        tag_name: ${{ env.TAG_NAME }}
        body: |
          **注意**
          このリリースは開発版です。  
          現時点での設定や機能は今後変更・削除される可能性があります。
        files: |
          ${{ env.NAR_NAME }}.nar
        prerelease: true
